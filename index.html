<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>発注フォーム</title>
<style>
  body{font-family:system-ui,Segoe UI,Meiryo;padding:16px;background:#87fa6a;color:#111}
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,60,0.04);margin-bottom:20px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  input[type=number], input[type=text]{padding:6px;border:1px solid #e6eefc;border-radius:6px}
  input[type=number]{width:80px}
  .btn{background:#1976d2;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:0.85rem}
  .btn.ghost{background:#f8f80cf7;color:#111;border:1px solid #d0d6e0}
  .btn.small{padding:4px 8px;font-size:0.8rem}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .totalArea{margin-top:16px;text-align:right;font-weight:600;font-size:1.1rem}
  .infoRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  #historySection{display:none;}
  .filter{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .small{font-size:0.9rem;color:#666}

  @media(max-width:600px){
  input[type=text], input[type=number]{
    width:100% !important; /* スマホでは幅いっぱい */
  }
  .row{
    flex-direction:column; /* 1列縦並び */
    align-items:stretch;
  }
}

</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h2>発注フォーム</h2>
    <button id="btnHistory" class="btn ghost" type="button">履歴</button>
  </div>

  <!-- 発注フォーム -->
  <div class="card">
    <div class="infoRow">
      <input id="storeNumber" type="text" placeholder="店番" style="width:120px">
      <input id="name" type="text" placeholder="店舗名" style="width:200px">
    </div>

    <table id="orderTable">
      <thead>
        <tr><th>産地</th><th>商品名</th><th>規格</th><th>入り数</th><th>単価</th><th>数量</th><th>小計</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totalArea">合計：¥<span id="grandTotal">0</span></div>

    <div style="margin-top:12px;text-align:right">
      <button id="btnSubmit" class="btn">発注する</button>
    </div>
  </div>

  <!-- 注文履歴 -->
  <div id="historySection" class="card">
    <h3>注文履歴</h3>
    <div id="historyTotal" class="totalArea" style="text-align:left;margin-bottom:6px;">
      合計：¥<span id="historyTotalAmount">0</span>
    </div>

    <div class="filter">
      <input id="filterNumber" placeholder="店番で検索" style="width:160px">
      <input id="filterName" placeholder="店舗名検索" style="width:200px">
      <button id="btnFilter" class="btn ghost">フィルタ</button>
      <button id="btnClear" class="btn ghost">解除</button>
      <div style="margin-left:auto" class="small">全件: <span id="ordersCount">0</span></div>
    </div>


    <div style="overflow:auto;max-height:420px">
      <table id="ordersTable">
        <thead>
          <tr>
            <th>ID</th><th>日時</th><th>店番</th><th>店舗名</th>
            <th>商品名</th><th>産地</th><th>規格</th><th>入り数</th>
            <th>単価</th><th>数量</th><th>小計</th><th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbzsxoLhzuBrPbVdL5PA4Q6AWbfFbKXBvSK0aWwWNcwsunzn9c9wlCJ-aLYbVn5T7Wg/exec';

//const API_BASE = 'https://script.google.com/macros/s/AKfycbwuDAfFHgf9wM90HCrpewcUK0tLUo7MpDnOrJC5Gn2gOkrpXP0GI1w2AE_uop49UzAV/exec';


//https://script.google.com/macros/s/AKfycbxOotTqGBxFi_uPSVfUZl5MI_A02NFxC7dULTN9vu6yJtxytfxKGSrGKGl1nxFG8CY_/exec

const tbody = document.querySelector('#orderTable tbody');
const grandTotalEl = document.getElementById('grandTotal');
const btnHistory = document.getElementById('btnHistory');
const btnSubmit = document.getElementById('btnSubmit');
const storeNumberEl = document.getElementById('storeNumber');
const nameEl = document.getElementById('name');
const historySection = document.getElementById('historySection');
let products = [];
let orders = [];

function escapeHtml(s){return String(s||'').replace(/[&<>"]+/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c));}

async function apiGetProducts(){const res = await fetch(API_BASE+'?action=getProducts');return res.json();}
async function apiGetOrders(){const res = await fetch(API_BASE+'?action=getOrders');return res.json();}

function renderTable(){
  tbody.innerHTML = '';
  products.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(p.origin)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${escapeHtml(p.spec||'')}</td>
      <td>${p.pack}</td>
      <td>¥${Number(p.price).toLocaleString()}</td>
      <td><input type="number" min="0" value="0" data-index="${i}"></td>
      <td class="subtotal" id="sub${i}">¥0</td>`;
    tbody.appendChild(tr);
  });
}

function calcTotals(){
  let total = 0;
  products.forEach((p,i)=>{
    const qty = Number(document.querySelector(`input[data-index="${i}"]`).value)||0;
    const subtotal = p.pack * p.price * qty;
    document.getElementById(`sub${i}`).textContent = '¥'+subtotal.toLocaleString();
    total += subtotal;
  });
  grandTotalEl.textContent = total.toLocaleString();
}

function attachEvents(){
  document.querySelectorAll('input[type=number]').forEach(inp=>{
    inp.addEventListener('input', calcTotals);
  });
}

// ====== 発注処理 ======
btnSubmit.onclick = async ()=>{
  const storeNumber = storeNumberEl.value.trim();
  const name = nameEl.value.trim();
  if(!storeNumber) return alert('店番を入力してください');
  if(!name) return alert('店舗名を入力してください');
  const ordersData = products.map((p,i)=>{
    const qty = Number(document.querySelector(`input[data-index="${i}"]`).value)||0;
    if(qty>0){
      return {
        id: Date.now() + '_' + storeNumber,
        productName:p.name, origin:p.origin, spec:p.spec,
        pack:p.pack, price:p.price, quantity:qty,
        subtotal:p.pack*p.price*qty
      };
    }
    return null;
  }).filter(x=>x);
  if(ordersData.length===0) return alert('数量を入力してください');
  try{
    const res = await fetch(API_BASE,{
      method:'POST',
      body:JSON.stringify({action:'addOrder', storeNumber, name, orders:ordersData})
    });
    const j = await res.json();
    if(j.success){
      alert('発注を送信しました');
      document.querySelectorAll('input[type=number]').forEach(i=>i.value=0);
      calcTotals();
      await loadOrders();
    }else alert('送信に失敗しました');
  }catch(e){ alert('通信エラー: '+e.message); }
};

// ====== 履歴表示 ======
const ordersTbody = document.querySelector('#ordersTable tbody');
const ordersCountEl = document.getElementById('ordersCount');
const filterNumber = document.getElementById('filterNumber');
const filterName = document.getElementById('filterName');
const btnFilter = document.getElementById('btnFilter');
const btnClear = document.getElementById('btnClear');

async function loadOrders(){
  try{
    const j = await apiGetOrders();
    if(!j.success) throw new Error(j.error||'API error');
    orders = j.orders;
    renderOrders(orders);
  }catch(e){alert('注文履歴の取得に失敗しました: '+e.message);}
}

function renderOrders(list){
  ordersTbody.innerHTML='';
  list.forEach((o, index)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${index + 1}</td>
      <td>${escapeHtml(o.date||'')}</td>
      <td>${escapeHtml(o.number||'')}</td>
      <td>${escapeHtml(o.name||'')}</td>
      <td>${escapeHtml(o.productName||'')}</td>
      <td>${escapeHtml(o.origin||'')}</td>
      <td>${escapeHtml(o.spec||'')}</td>
      <td>${escapeHtml(o.pack||'')}</td>
      <td>${escapeHtml(o.price||'')}</td>
      <td>${escapeHtml(o.quantity||'')}</td>
      <td>${escapeHtml(o.subtotal||'')}</td>
      <td>
        <button class="btn ghost small btn-edit" data-index="${index}">修正</button>
        <button class="btn ghost small btn-del" data-index="${index}">削除</button>
      </td>`;
    ordersTbody.appendChild(tr);
  });
  ordersCountEl.textContent=list.length;
  
  function updateHistoryTotal(list){
  const total = list.reduce((sum, o) => sum + Number(o.subtotal || 0), 0);
  document.getElementById('historyTotalAmount').textContent = total.toLocaleString();
  }

  updateHistoryTotal(list);
  
  document.querySelectorAll('.btn-del').forEach(btn=>{
    btn.onclick=async ()=>{
      if(!confirm('削除してよろしいですか？')) return;
      const rowIndex = Number(btn.dataset.index);
      try{
        const res=await fetch(API_BASE,{
          method:'POST',
          body:JSON.stringify({action:'deleteOrder', rowIndex})
        });
        const j=await res.json();
        if(j.success){alert('削除しました');await loadOrders();}
        else alert('削除に失敗しました');
      }catch(e){alert('通信エラー:'+e.message);}
    };
  });

  document.querySelectorAll('.btn-edit').forEach(btn=>{
    btn.onclick=()=>{
      const rowIndex = Number(btn.dataset.index);
      const order = orders[rowIndex];
      if(!order) return;
      const newQty = prompt('新しい数量を入力', order.quantity);
      if(newQty===null) return;
      const updated = {...order, quantity:Number(newQty), subtotal:order.price*order.pack*Number(newQty)};
      updateOrder(updated, rowIndex);
    };
  });
}

async function updateOrder(order, rowIndex){
  try{
    const res = await fetch(API_BASE,{
      method:'POST',
      body:JSON.stringify({action:'updateOrder', rowIndex, order})
    });
    const j = await res.json();
    if(j.success){
      alert('修正を保存しました');
      await loadOrders();
    }else alert('修正に失敗しました');
  }catch(e){alert('通信エラー:'+e.message);}
}


btnFilter.onclick=()=>{
  const n=filterNumber.value.trim().toLowerCase();
  const nm=filterName.value.trim().toLowerCase();
  const filtered=orders.filter(o=>{
    if(n && String(o.number||'').toLowerCase().indexOf(n)===-1) return false;
    if(nm && String(o.name||'').toLowerCase().indexOf(nm)===-1) return false;
    return true;
  });
  renderOrders(filtered);
};
btnClear.onclick=()=>{filterNumber.value='';filterName.value='';renderOrders(orders);};

btnHistory.onclick=async ()=>{
  if(historySection.style.display==='none'){
    historySection.style.display='block';
    await loadOrders();
  }else{
    historySection.style.display='none';
  }
};

(async()=>{
  try{
    const j = await apiGetProducts();
    if(!j.success) throw new Error(j.error||'API error');
    products = j.products;
    renderTable();
    attachEvents();
  }catch(e){alert('商品データの読み込みに失敗しました: '+e.message);}
})();
</script>
</body>
</html>
